import { Context, InlineKeyboard } from 'grammy';
import { UserService } from '../../services/user-service';
import { AuthService } from '../../services/auth-service';
import type { DrizzleD1Database } from 'drizzle-orm/d1';

/**
 * StartCommand - Telegram Bot /start Command Handler
 *
 * Handles the /start command with comprehensive user onboarding:
 * - User authentication and session management
 * - Welcome message with marketplace introduction
 * - Interactive inline keyboard with navigation options
 * - WebApp integration for marketplace access
 * - Support for both private and group chat contexts
 */

export interface BotContext {
  db: DrizzleD1Database;
  env: any;
  corsHeaders: Record<string, string>;
  isLocalhost: boolean;
  botName: string | null;
}

export class StartCommand {
  private userService: UserService;
  private authService: AuthService;
  private context: BotContext;

  constructor(context: BotContext) {
    this.context = context;
    this.userService = new UserService(context.db);
    this.authService = new AuthService(context.db, context.env.TELEGRAM_BOT_TOKEN);
  }

  /**
   * Handle /start command
   * Provides welcome message and main navigation options
   */
  async handle(ctx: Context): Promise<void> {
    try {
      const chatId = ctx.chat?.id;
      const messageId = ctx.message?.message_id;
      const user = ctx.from;

      if (!chatId || !user) {
        console.error('Missing chat ID or user information');
        return;
      }

      // Log command usage for analytics
      console.log('Bot command /start:', {
        user_id: user.id,
        username: user.username,
        chat_id: chatId,
        chat_type: ctx.chat?.type,
        timestamp: new Date().toISOString(),
      });

      // Handle authentication and user creation/update
      const authResult = await this.handleUserAuthentication(user);

      // Check if user is banned
      if (authResult.user?.banned) {
        await this.sendBannedUserMessage(ctx, authResult.user);
        return;
      }

      // Send different messages based on chat type
      if (ctx.chat?.type === 'private') {
        await this.sendPrivateWelcomeMessage(ctx, authResult.isNewUser);
      } else {
        await this.sendGroupWelcomeMessage(ctx);
      }
    } catch (error) {
      console.error('Error handling /start command:', error);
      await this.sendErrorMessage(ctx);
    }
  }

  /**
   * Handle user authentication and creation/update
   */
  private async handleUserAuthentication(user: any): Promise<any> {
    try {
      // Check if user exists
      let existingUser = await this.userService.getUserByTelegramId(user.id.toString());
      let isNewUser = false;

      if (!existingUser) {
        // Create new user
        const userData = {
          telegramId: user.id.toString(),
          firstName: user.first_name || '',
          lastName: user.last_name || '',
          username: user.username || '',
          photoUrl: '',
          languageCode: user.language_code || 'en',
          isBot: false,
          isPremium: user.is_premium || false,
          banned: false,
          banReason: null,
          lastActiveAt: new Date(),
          createdAt: new Date(),
          updatedAt: new Date(),
        };

        existingUser = await this.userService.createUser(userData);
        isNewUser = true;

        console.log('New user created:', {
          id: existingUser.id,
          telegramId: existingUser.telegramId,
          username: existingUser.username,
        });
      } else {
        // Update existing user information
        const updateData = {
          firstName: user.first_name || existingUser.firstName,
          lastName: user.last_name || existingUser.lastName,
          username: user.username || existingUser.username,
          isPremium: user.is_premium || existingUser.isPremium,
          lastActiveAt: new Date(),
          updatedAt: new Date(),
        };

        existingUser = await this.userService.updateUser(existingUser.id, updateData);

        console.log('User updated:', {
          id: existingUser.id,
          telegramId: existingUser.telegramId,
          username: existingUser.username,
        });
      }

      return { user: existingUser, isNewUser };
    } catch (error) {
      console.error('Error in user authentication:', error);
      throw error;
    }
  }

  /**
   * Send welcome message for private chat
   */
  private async sendPrivateWelcomeMessage(ctx: Context, isNewUser?: boolean): Promise<void> {
    const webAppUrl = this.context.isLocalhost
      ? 'https://localhost:5173'
      : `https://${this.context.env.WEBAPP_DOMAIN || 'your-marketplace.com'}`;

    const greeting = isNewUser ? 'üëã Welcome to our Marketplace!' : 'üëã Welcome back!';

    const welcomeMessage = `
${greeting}

üõçÔ∏è **Your Digital Marketplace**
Discover, buy, and sell digital products with ease through our Telegram Web App.

**What you can do:**
‚Ä¢ üîç Browse thousands of digital products
‚Ä¢ üìù Create and manage your listings
‚Ä¢ üí¨ Chat directly with buyers/sellers
‚Ä¢ ‚≠ê Rate and review transactions
‚Ä¢ üîî Get instant notifications

**Getting Started:**
1. Tap "Open Marketplace" below
2. Browse or create your first listing
3. Start buying and selling!

Need help? Use /help or /question to contact support.
    `.trim();

    // Create inline keyboard with navigation options
    const keyboard = new InlineKeyboard()
      .webApp('üõçÔ∏è Open Marketplace', webAppUrl)
      .row()
      .text('üìö Help & Guide', 'help_guide')
      .text('üí¨ Contact Support', 'contact_support')
      .row()
      .text('üìä My Account', 'my_account')
      .text('‚öôÔ∏è Settings', 'user_settings');

    await ctx.reply(welcomeMessage, {
      reply_markup: keyboard,
      parse_mode: 'Markdown',
      disable_web_page_preview: true,
    });
  }

  /**
   * Send welcome message for group chat
   */
  private async sendGroupWelcomeMessage(ctx: Context): Promise<void> {
    const groupMessage = `
üëã Hi there! I'm the marketplace bot.

üõçÔ∏è **For the full marketplace experience:**
‚Ä¢ Message me privately to browse and create listings
‚Ä¢ Use /help to see available commands
‚Ä¢ Admins can use /question for support

**Quick Commands:**
/start - Get started (works in DM)
/help - Show help information
/question - Contact admin for support
    `.trim();

    const keyboard = new InlineKeyboard().url(
      'üí¨ Start Private Chat',
      `https://t.me/${this.context.botName}?start=group_referral`
    );

    await ctx.reply(groupMessage, {
      reply_markup: keyboard,
      parse_mode: 'Markdown',
    });
  }

  /**
   * Send message for banned users
   */
  private async sendBannedUserMessage(ctx: Context, user: any): Promise<void> {
    const banReason = user.banReason || 'Terms of service violation';

    const bannedMessage = `
üö´ **Account Suspended**

Your account has been suspended from the marketplace.

**Reason:** ${banReason}
**Date:** ${user.bannedAt ? new Date(user.bannedAt).toLocaleDateString() : 'N/A'}

**What you can do:**
‚Ä¢ Review our Terms of Service
‚Ä¢ Submit an appeal using /appeal if you believe this was a mistake
‚Ä¢ Contact support with /question for more information

**Appeal Process:**
Type: \`/appeal [your explanation]\`
Example: \`/appeal I believe this ban was issued in error because...\`
    `.trim();

    const keyboard = new InlineKeyboard()
      .text('üìù Submit Appeal', 'submit_appeal')
      .row()
      .text('üí¨ Contact Support', 'contact_support');

    await ctx.reply(bannedMessage, {
      reply_markup: keyboard,
      parse_mode: 'Markdown',
    });
  }

  /**
   * Send error message when something goes wrong
   */
  private async sendErrorMessage(ctx: Context): Promise<void> {
    const errorMessage = `
‚ùå **Oops! Something went wrong**

We're experiencing a temporary issue. Please try again in a few moments.

If the problem persists:
‚Ä¢ Use /help for assistance
‚Ä¢ Contact support with /question
‚Ä¢ Check our status page

**Error Code:** START_CMD_ERROR_${Date.now()}
    `.trim();

    const keyboard = new InlineKeyboard()
      .text('üîÑ Try Again', 'retry_start')
      .text('üí¨ Get Help', 'contact_support');

    await ctx.reply(errorMessage, {
      reply_markup: keyboard,
      parse_mode: 'Markdown',
    });
  }

  /**
   * Handle callback queries from inline keyboard buttons
   */
  async handleCallback(ctx: Context, data: string): Promise<void> {
    try {
      switch (data) {
        case 'help_guide':
          await this.sendHelpGuide(ctx);
          break;
        case 'contact_support':
          await this.sendContactSupport(ctx);
          break;
        case 'my_account':
          await this.sendMyAccount(ctx);
          break;
        case 'user_settings':
          await this.sendUserSettings(ctx);
          break;
        case 'submit_appeal':
          await this.sendAppealInstructions(ctx);
          break;
        case 'retry_start':
          await this.handle(ctx);
          break;
        default:
          await ctx.answerCallbackQuery('Unknown action');
      }
    } catch (error) {
      console.error('Error handling callback:', error);
      await ctx.answerCallbackQuery('Error processing request');
    }
  }

  /**
   * Send help guide
   */
  private async sendHelpGuide(ctx: Context): Promise<void> {
    const helpMessage = `
üìö **Marketplace Guide**

**For Buyers:**
‚Ä¢ Browse categories and search for products
‚Ä¢ Read reviews and ratings
‚Ä¢ Contact sellers directly
‚Ä¢ Make secure purchases

**For Sellers:**
‚Ä¢ Create detailed product listings
‚Ä¢ Upload high-quality images
‚Ä¢ Set competitive prices
‚Ä¢ Respond to buyer inquiries

**Tips for Success:**
‚Ä¢ Use clear, honest descriptions
‚Ä¢ Respond quickly to messages
‚Ä¢ Maintain a good rating
‚Ä¢ Follow marketplace guidelines

Type /help for more commands!
    `.trim();

    await ctx.editMessageText(helpMessage, {
      parse_mode: 'Markdown',
      reply_markup: new InlineKeyboard().text('‚Üê Back to Start', 'back_to_start'),
    });
  }

  /**
   * Send contact support options
   */
  private async sendContactSupport(ctx: Context): Promise<void> {
    const supportMessage = `
üí¨ **Contact Support**

Need help? Our support team is here for you!

**How to get help:**
1. Use /question followed by your message
2. Be specific about your issue
3. Include relevant details (listing ID, error messages, etc.)

**Response Time:**
‚Ä¢ General questions: Within 24 hours
‚Ä¢ Technical issues: Within 12 hours
‚Ä¢ Urgent matters: Within 4 hours

**Example:**
\`/question I can't upload images to my listing. Getting error code 123.\`

Our team will respond directly to you!
    `.trim();

    await ctx.editMessageText(supportMessage, {
      parse_mode: 'Markdown',
      reply_markup: new InlineKeyboard().text('‚Üê Back to Start', 'back_to_start'),
    });
  }

  /**
   * Send account information
   */
  private async sendMyAccount(ctx: Context): Promise<void> {
    try {
      const user = await this.userService.getUserByTelegramId(ctx.from?.id?.toString() || '');

      if (!user) {
        await ctx.answerCallbackQuery('User not found');
        return;
      }

      const accountMessage = `
üìä **My Account**

**Profile Information:**
‚Ä¢ Name: ${user.firstName} ${user.lastName || ''}
‚Ä¢ Username: @${user.username || 'not set'}
‚Ä¢ Member since: ${new Date(user.createdAt).toLocaleDateString()}
‚Ä¢ Status: ${user.banned ? 'üö´ Suspended' : '‚úÖ Active'}

**Marketplace Stats:**
‚Ä¢ Active listings: Loading...
‚Ä¢ Total sales: Loading...
‚Ä¢ Rating: Loading...
‚Ä¢ Reviews: Loading...

**Account Level:** ${user.isPremium ? '‚≠ê Premium' : 'üÜì Standard'}

Open the marketplace to see detailed statistics!
      `.trim();

      await ctx.editMessageText(accountMessage, {
        parse_mode: 'Markdown',
        reply_markup: new InlineKeyboard()
          .webApp(
            'üìä View Full Stats',
            `${this.context.isLocalhost ? 'https://localhost:5173' : `https://${this.context.env.WEBAPP_DOMAIN}`}/profile`
          )
          .row()
          .text('‚Üê Back to Start', 'back_to_start'),
      });
    } catch (error) {
      console.error('Error getting account info:', error);
      await ctx.answerCallbackQuery('Error loading account information');
    }
  }

  /**
   * Send user settings
   */
  private async sendUserSettings(ctx: Context): Promise<void> {
    const settingsMessage = `
‚öôÔ∏è **Settings**

**Notification Preferences:**
‚Ä¢ üîî New messages: Enabled
‚Ä¢ üìù Listing updates: Enabled
‚Ä¢ üí∞ Payment notifications: Enabled
‚Ä¢ üìä Weekly reports: Disabled

**Privacy Settings:**
‚Ä¢ Profile visibility: Public
‚Ä¢ Contact preferences: Telegram only
‚Ä¢ Show online status: Yes

**Language:** English (EN)

**Note:** Advanced settings are available in the web app.
    `.trim();

    await ctx.editMessageText(settingsMessage, {
      parse_mode: 'Markdown',
      reply_markup: new InlineKeyboard()
        .webApp(
          '‚öôÔ∏è Advanced Settings',
          `${this.context.isLocalhost ? 'https://localhost:5173' : `https://${this.context.env.WEBAPP_DOMAIN}`}/settings`
        )
        .row()
        .text('‚Üê Back to Start', 'back_to_start'),
    });
  }

  /**
   * Send appeal instructions
   */
  private async sendAppealInstructions(ctx: Context): Promise<void> {
    const appealMessage = `
üìù **Submit Appeal**

To appeal your account suspension:

**Format:**
\`/appeal [Your detailed explanation]\`

**Include:**
‚Ä¢ Why you believe the ban was incorrect
‚Ä¢ Any relevant context or evidence
‚Ä¢ Your commitment to follow guidelines

**Example:**
\`/appeal I was banned for spam, but I only posted one legitimate listing for my digital artwork. I believe this was flagged by mistake as I followed all posting guidelines.\`

**Review Process:**
‚Ä¢ Appeals are reviewed within 48 hours
‚Ä¢ You'll receive a response via this chat
‚Ä¢ Decision will include detailed explanation

**Note:** Only submit appeals if you genuinely believe there was an error.
    `.trim();

    await ctx.editMessageText(appealMessage, {
      parse_mode: 'Markdown',
      reply_markup: new InlineKeyboard().text('‚Üê Back to Start', 'back_to_start'),
    });
  }
}
